import React, { useState, useEffect, useRef } from "react";
import axios from "axios";
import {
  ShieldAlert, LayoutDashboard, Target, Terminal as TerminalIcon,
  FileText, Settings, Wrench, Zap, Search, Globe
} from "lucide-react";

export default function AutomatedPentest() {
  const [target, setTarget] = useState("");
  const [logs, setLogs] = useState([]);
  const [isScanning, setIsScanning] = useState(false);
  const logEndRef = useRef(null);

  const theme = {
    bg: "#0a0a0c",
    sidebar: "#0d0d10",
    card: "#111114",
    border: "rgba(255, 255, 255, 0.05)",
    accent: "linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)",
    textMain: "#e2e8f0",
    textDim: "#94a3b8",
    terminal: "#050505"
  };

  // Auto-scroll logs
  useEffect(() => {
    logEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  // üî¥ START AUTO PENTEST
  const handleStartPentest = async (e) => {
    e.preventDefault();
    if (!target || isScanning) return;

    setLogs([
      `[INIT] Initializing Automated Pentest for: ${target}`,
      "[AI] Preparing attack plan..."
    ]);

    setIsScanning(true);

    try {
      await axios.post("http://127.0.0.1:8000/auto/start", { target });
    } catch {
      setLogs(prev => [...prev, "[ERROR] Failed to start auto pipeline"]);
      setIsScanning(false);
    }
  };

  // üî¥ LIVE LOG POLLING (SINGLE SOURCE OF TRUTH)
  useEffect(() => {
    if (!isScanning) return;

    const interval = setInterval(async () => {
      try {
        const res = await axios.get("http://127.0.0.1:8000/auto/logs");

        if (Array.isArray(res.data.logs)) {
          setLogs(res.data.logs);
        }

        if (res.data.status === "DONE" || res.data.status === "ERROR") {
          setIsScanning(false);
        }

      } catch {
        console.error("Log polling failed");
      }
    }, 2000);

    return () => clearInterval(interval);
  }, [isScanning]);

  const navigate = (e) => {
    e.preventDefault();
    window.location.hash = "#";
  };

  return (
    <div style={{ display: "flex", height: "100vh", backgroundColor: theme.bg, color: theme.textMain }}>

      {/* SIDEBAR */}
      <aside style={{ width: 280, backgroundColor: theme.sidebar, borderRight: `1px solid ${theme.border}` }}>
        <div style={{ padding: 32, display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ width: 36, height: 36, background: theme.accent, borderRadius: 10, display: "flex", alignItems: "center", justifyContent: "center" }}>
            <ShieldAlert size={20} color="white" />
          </div>
          <span style={{ fontSize: 20, fontWeight: "bold", fontStyle: "italic" }}>
            RedOps <span style={{ color: "#3b82f6" }}>AI</span>
          </span>
        </div>

        <nav style={{ padding: "0 16px" }}>
          <NavItem icon={<LayoutDashboard size={18} />} label="Dashboard" onClick={navigate} />
          <NavItem icon={<Target size={18} />} label="Scopes" onClick={navigate} />
          <NavItem icon={<TerminalIcon size={18} />} label="Automated Scans" active onClick={navigate} />
          <NavItem icon={<FileText size={18} />} label="Reports" onClick={navigate} />
          <NavItem icon={<Settings size={18} />} label="Settings" onClick={navigate} />
        </nav>
      </aside>

      {/* MAIN */}
      <main style={{ flex: 1, display: "flex", flexDirection: "column" }}>

        {/* HEADER */}
        <header style={{ height: 64, borderBottom: `1px solid ${theme.border}`, padding: "0 32px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
            <Globe size={16} color="#3b82f6" />
            <span style={{ fontSize: 12, color: theme.textDim }}>Network / Auto Mode</span>
          </div>
          <span style={{ fontSize: 10, color: "#22c55e", fontWeight: "bold" }}>‚óè SYSTEM ACTIVE</span>
        </header>

        {/* BODY */}
        <div style={{ padding: 40, overflowY: "auto" }}>
          <h1 style={{ fontSize: 28, fontWeight: "bold" }}>Automated Pentest</h1>
          <p style={{ color: theme.textDim, marginBottom: 24 }}>AI-driven autonomous attack pipeline</p>

          {/* INPUT */}
          <form onSubmit={handleStartPentest} style={{ display: "flex", gap: 12, marginBottom: 32 }}>
            <div style={{ flex: 1, position: "relative" }}>
              <Search size={18} style={{ position: "absolute", left: 16, top: "50%", transform: "translateY(-50%)", color: "#475569" }} />
              <input
                value={target}
                onChange={e => setTarget(e.target.value)}
                placeholder="Target IP or domain"
                style={{ width: "94%", padding: "14px 14px 14px 48px", background: "#050505", border: `1px solid ${theme.border}`, borderRadius: 10, color: "white" }}
              />
            </div>
            <button disabled={isScanning} style={{ padding: "0 24px", background: theme.accent, borderRadius: 10, color: "white", fontWeight: "bold" }}>
              <Wrench size={15} /> {isScanning ? "Running..." : "Start Pentest"}
            </button>
          </form>

          {/* TERMINAL */}
          <div style={{ height: 450, background: theme.terminal, borderRadius: 16, border: `1px solid ${theme.border}`, overflow: "hidden" }}>
            <div style={{ padding: "12px 24px", background: "#111", fontSize: 11, color: "#94a3b8" }}>
              LIVE_EXECUTION_STREAM
            </div>
            <div style={{ padding: 24, fontFamily: "monospace", fontSize: 13, overflowY: "auto", height: "100%" }}>
              {logs.length === 0 ? (
                <div style={{ color: "#334155", textAlign: "center", marginTop: 120 }}>
                  <Zap size={32} opacity={0.2} /><br />
                  Awaiting target input...
                </div>
              ) : logs.map((l, i) => <LogLine key={i} text={l} />)}
              <div ref={logEndRef} />
            </div>
          </div>

        </div>
      </main>
    </div>
  );
}

// Components
function NavItem({ icon, label, active, onClick }) {
  return (
    <a href="#" onClick={onClick} style={{ textDecoration: "none" }}>
      <div style={{ padding: "12px 16px", display: "flex", gap: 12, borderRadius: 12, color: active ? "#3b82f6" : "#94a3b8" }}>
        {icon} {label}
      </div>
    </a>
  );
}

function LogLine({ text }) {
  const color =
    text.includes("[ERROR]") ? "#f87171" :
    text.includes("[AI]") ? "#c084fc" :
    text.includes("[INIT]") ? "#3b82f6" :
    "#4ade80";

  return (
    <div style={{ color, marginBottom: 6 }}>
      &gt; {text}
    </div>
  );
}
