from backend.vulnerability_assessment.schema import base_va_schema
from backend.vulnerability_assessment.attack_surface import infer_attack_surface
from backend.vulnerability_assessment.cve_lookup import lookup_cves


class VulnerabilityAssessmentEngine:
    def __init__(self, recon_result: dict, directories: list | None = None):
        self.recon = recon_result
        self.directories = directories or []

    def run(self):
        target = self.recon["meta"]["target"]
        va_result = base_va_schema(target)

        # ----------------------------
        # 1. Attack surface inference
        # ----------------------------
        attack_surface = infer_attack_surface(self.recon.get("data", {}))

        # ----------------------------
        # 2. CVE-based findings
        # ----------------------------
        cves = lookup_cves(attack_surface)
        for cve in cves:
            va_result["findings"].append({
                "type": "cve",
                "id": cve.get("cve"),
                "description": cve.get("description"),
                "severity": cve.get("severity", "medium"),
                "confidence": "high"
            })

        # ----------------------------
        # 3. Heuristic SQL injection risk
        # ----------------------------
        if any(p in "/".join(self.directories).lower() for p in ["login", "admin", "search", "product"]):
            va_result["findings"].append({
                "type": "sql_injection_risk",
                "description": (
                    "Dynamic application paths were identified that commonly interact "
                    "with backend databases. If user input is not properly sanitized, "
                    "this may allow SQL injection attacks."
                ),
                "severity": "high",
                "confidence": "high"
            })

        # ----------------------------
        # 4. Legacy stack exposure
        # ----------------------------
        server = self.recon.get("data", {}).get("http_headers", {}).get("server", "").lower()
        if any(s in server for s in ["apache", "php"]):
            va_result["findings"].append({
                "type": "legacy_stack_exposure",
                "description": (
                    "The application appears to use a legacy web stack. "
                    "Such stacks are frequently affected by known vulnerabilities "
                    "if not continuously patched and hardened."
                ),
                "severity": "medium",
                "confidence": "medium"
            })

        # ----------------------------
        # 5. Safety net (never return empty)
        # ----------------------------
        if not va_result["findings"]:
            va_result["findings"].append({
                "type": "informational",
                "description": (
                    "No confirmed exploitable vulnerabilities were detected, "
                    "however the exposed attack surface warrants continuous monitoring "
                    "and secure coding practices."
                ),
                "severity": "info",
                "confidence": "low"
            })

        return va_result
